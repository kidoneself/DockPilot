# GitHub Actions é…ç½® - éœ€è¦æ”¾åˆ° .github/workflows/ ç›®å½•ä¸‹
name: ğŸš€ Build and Release Hot Update

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write
  packages: write
  actions: read

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '11'

jobs:
  build-frontend:
    name: ğŸ“¦ æ„å»ºå‰ç«¯
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“‹ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dockpilot-frontend/package-lock.json

      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: dockpilot-frontend
        run: |
          npm ci
          # å‡çº§å…³é”®ä¾èµ–ä»¥è§£å†³å…¼å®¹æ€§é—®é¢˜
          npm install vue-tsc@latest --save-dev
          npm install terser --save-dev

      - name: ğŸ”§ æ„å»ºå‰ç«¯ï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰
        working-directory: dockpilot-frontend
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºå‰ç«¯..."
          
          # å¤‡ä»½åŸå§‹ package.json
          cp package.json package.json.backup
          
          # ä¿®æ”¹æ„å»ºè„šæœ¬è·³è¿‡ç±»å‹æ£€æŸ¥
          sed -i 's/"build": "vue-tsc && vite build"/"build": "vite build"/' package.json
          
          # æ‰§è¡Œæ„å»º
          npm run build
          
          # æ¢å¤åŸå§‹ package.json
          mv package.json.backup package.json
          
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

      - name: ğŸ“ æ‰“åŒ…å‰ç«¯æ–‡ä»¶
        working-directory: dockpilot-frontend
        run: |
          echo "ğŸ“¦ æ‰“åŒ…å‰ç«¯æ–‡ä»¶..."
          tar -czf ../frontend.tar.gz -C dist .
          echo "âœ… å‰ç«¯æ‰“åŒ…å®Œæˆ: frontend.tar.gz"

      - name: ğŸ“¤ ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend.tar.gz
          retention-days: 1

  build-backend:
    name: âš™ï¸ æ„å»ºåç«¯
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½®Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ“‹ è®¾ç½®Mavenç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ”§ æ„å»ºåç«¯
        working-directory: dockpilot-backend
        run: |
          echo "âš™ï¸ å¼€å§‹æ„å»ºåç«¯..."
          mvn clean package -DskipTests -q
          echo "âœ… åç«¯æ„å»ºå®Œæˆ"

      - name: ğŸ“ å‡†å¤‡åç«¯æ–‡ä»¶
        working-directory: dockpilot-backend
        run: |
          echo "ğŸ“¦ å‡†å¤‡åç«¯jaræ–‡ä»¶..."
          
          # æŸ¥æ‰¾æ„å»ºçš„jaræ–‡ä»¶
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°jaræ–‡ä»¶"
            exit 1
          fi
          
          echo "æ‰¾åˆ°jaræ–‡ä»¶: $JAR_FILE"
          
          # é‡å‘½åä¸ºç»Ÿä¸€çš„åç§°
          cp "$JAR_FILE" ../backend.jar
          
          echo "âœ… åç«¯æ–‡ä»¶å‡†å¤‡å®Œæˆ: backend.jar"

      - name: ğŸ“¤ ä¸Šä¼ åç«¯æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend.jar
          retention-days: 1

  create-release:
    name: ğŸ‰ åˆ›å»ºå‘å¸ƒ
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: ğŸ“¥ ä¸‹è½½åç«¯æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: backend-build

      - name: ğŸ” éªŒè¯æ„å»ºæ–‡ä»¶
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºæ–‡ä»¶..."
          
          # æ£€æŸ¥å‰ç«¯æ–‡ä»¶
          if [ ! -f "frontend.tar.gz" ]; then
            echo "âŒ frontend.tar.gz ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥åç«¯æ–‡ä»¶
          if [ ! -f "backend.jar" ]; then
            echo "âŒ backend.jar ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“ æ–‡ä»¶ä¿¡æ¯:"
          ls -lh frontend.tar.gz backend.jar
          
          # éªŒè¯taræ–‡ä»¶
          if tar -tzf frontend.tar.gz >/dev/null 2>&1; then
            echo "âœ… frontend.tar.gz æ ¼å¼æ­£ç¡®"
          else
            echo "âŒ frontend.tar.gz æ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          # éªŒè¯jaræ–‡ä»¶
          if file backend.jar | grep -q "Java archive"; then
            echo "âœ… backend.jar æ ¼å¼æ­£ç¡®"
          else
            echo "âŒ backend.jar æ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: ğŸ“‹ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release-notes
        run: |
          # è·å–ç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat > release-notes.md << EOF
          ## ğŸš€ DockPilot $VERSION çƒ­æ›´æ–°ç‰ˆæœ¬
          
          è¿™æ˜¯ä¸€ä¸ªæ”¯æŒå®¹å™¨å†…çƒ­æ›´æ–°çš„ç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
          
          ### ğŸ“¦ åŒ…å«æ–‡ä»¶
          - **frontend.tar.gz**: å‰ç«¯æ„å»ºåŒ… (Vue3 + TypeScript)
          - **backend.jar**: åç«¯åº”ç”¨åŒ… (Spring Boot)
          
          ### ğŸ”¥ çƒ­æ›´æ–°ç‰¹æ€§
          - âœ… å®¹å™¨å†…çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯å®¹å™¨
          - âœ… è‡ªåŠ¨ç‰ˆæœ¬æ£€æŸ¥å’Œæç¤º
          - âœ… å‰ç«¯æ— åˆ·æ–°æ›´æ–°
          - âœ… åç«¯æœåŠ¡çƒ­é‡å¯
          - âœ… è‡ªåŠ¨å¤‡ä»½å’Œå›æ»šæœºåˆ¶
          
          ### ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•
          
          #### æ–¹å¼ä¸€ï¼šç›´æ¥éƒ¨ç½²çƒ­æ›´æ–°é•œåƒ
          \`\`\`bash
          # æ¨èæ–¹å¼ï¼ˆlatestå³çƒ­æ›´æ–°ç‰ˆï¼‰
          docker run -d --privileged \\
            --name dockpilot \\
            -p 8888:8888 \\
            -v /var/run/docker.sock:/var/run/docker.sock \\
            -v /:/mnt/host \\
            -v /home/dockpilot:/dockpilot \\
            -e DOCKPILOT_VERSION=$VERSION \\
            --restart unless-stopped \\
            kidself/dockpilot:latest
          
          # æˆ–æ˜ç¡®æŒ‡å®šçƒ­æ›´æ–°ç‰ˆ
          docker run -d --privileged \\
            --name dockpilot \\
            -p 8888:8888 \\
            -v /var/run/docker.sock:/var/run/docker.sock \\
            -v /:/mnt/host \\
            -v /home/dockpilot:/dockpilot \\
            -e DOCKPILOT_VERSION=$VERSION \\
            --restart unless-stopped \\
            kidself/dockpilot:hot
          \`\`\`
          
          #### æ–¹å¼äºŒï¼šåœ¨ç°æœ‰å®¹å™¨ä¸­æ‰‹åŠ¨æ›´æ–°
          1. è®¿é—®ç®¡ç†ç•Œé¢å³ä¸Šè§’çš„æ›´æ–°æŒ‰é’®
          2. ç‚¹å‡»æ£€æŸ¥æ›´æ–°
          3. ç¡®è®¤æ‰§è¡Œçƒ­æ›´æ–°
          4. ç­‰å¾…æ›´æ–°å®Œæˆï¼ˆçº¦2-5åˆ†é’Ÿï¼‰
          
          ### ğŸ“‹ æ›´æ–°æ—¥å¿—
          - ğŸ‰ æ”¯æŒå®¹å™¨å†…çƒ­æ›´æ–°åŠŸèƒ½
          - ğŸ”§ ä¼˜åŒ–å‰åç«¯æ„å»ºæµç¨‹  
          - ğŸ› ä¿®å¤å·²çŸ¥é—®é¢˜
          - ğŸ“š å®Œå–„æ–‡æ¡£å’Œè¯´æ˜
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - çƒ­æ›´æ–°è¿‡ç¨‹ä¸­å¯èƒ½æœ‰1-2åˆ†é’Ÿçš„æœåŠ¡ä¸­æ–­
          - è¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®šï¼Œä»¥ä¾¿ä¸‹è½½æ›´æ–°åŒ…
          - å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œæ›´æ–°æ“ä½œ
          - å¦‚é‡é—®é¢˜ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬
          
          ---
          
          **æ„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **æ„å»ºç¯å¢ƒ**: GitHub Actions  
          **å‰ç«¯æŠ€æœ¯æ ˆ**: Vue 3 + TypeScript + Element Plus  
          **åç«¯æŠ€æœ¯æ ˆ**: Spring Boot + Java 11  
          EOF

      - name: ğŸ‰ åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-notes.outputs.VERSION }}
          name: ğŸš€ DockPilot ${{ steps.release-notes.outputs.VERSION }} (çƒ­æ›´æ–°ç‰ˆæœ¬)
          body_path: release-notes.md
          files: |
            frontend.tar.gz
            backend.jar
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š å‘å¸ƒæ€»ç»“
        run: |
          echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
          echo "  ç‰ˆæœ¬: ${{ steps.release-notes.outputs.VERSION }}"
          echo "  å‰ç«¯åŒ…: frontend.tar.gz"
          echo "  åç«¯åŒ…: backend.jar"
          echo "  å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release-notes.outputs.VERSION }}"
          echo ""
          echo "ğŸ”— ä¸‹è½½é“¾æ¥:"
          echo "  å‰ç«¯: https://github.com/${{ github.repository }}/releases/download/${{ steps.release-notes.outputs.VERSION }}/frontend.tar.gz"
          echo "  åç«¯: https://github.com/${{ github.repository }}/releases/download/${{ steps.release-notes.outputs.VERSION }}/backend.jar"

  build-docker-image:
    name: ğŸ³ æ„å»ºDockeré•œåƒ
    needs: [create-release]
    runs-on: ubuntu-latest
    # ğŸ”¥ çƒ­æ›´æ–°ç­–ç•¥ï¼šé•œåƒåªéœ€æ„å»ºä¸€æ¬¡ï¼Œä»£ç é€šè¿‡çƒ­æ›´æ–°ï¼
    # 
    # åªåœ¨ä»¥ä¸‹æƒ…å†µæ‰é‡æ–°æ„å»ºDockeré•œåƒï¼š
    # 1. æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œï¼‰
    # 2. commitä¿¡æ¯åŒ…å«[docker]æ ‡ç­¾ï¼ˆå¼ºåˆ¶æ„å»ºé•œåƒï¼‰
    # 3. åŸºç¡€ç¯å¢ƒéœ€è¦æ›´æ–°æ—¶ï¼ˆå¦‚Javaç‰ˆæœ¬ã€Caddyé…ç½®ç­‰ï¼‰
    #
    # ğŸ¯ æ­£å¸¸ä»£ç æ›´æ–°åªéœ€å‘å¸ƒfrontend.tar.gzå’Œbackend.jarï¼
    if: |
      github.event_name == 'workflow_dispatch' || 
      contains(github.event.head_commit.message, '[docker]')
    
    # ğŸ’¡ è¿™æ ·çš„å¥½å¤„ï¼š
    # - âš¡ å‘å¸ƒé€Ÿåº¦å¿«ï¼ˆ2-3åˆ†é’Ÿ vs 8-10åˆ†é’Ÿï¼‰
    # - ğŸ’° èŠ‚çœCIèµ„æº
    # - ğŸ”„ çœŸæ­£çš„çƒ­æ›´æ–°ä½“éªŒ
    # - ğŸ¯ é•œåƒç¨³å®šï¼Œä»£ç çµæ´»
    steps:
      - name: ğŸ›ï¸ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ³ è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“‹ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ³ æ„å»ºå¹¶æ¨é€çƒ­æ›´æ–°é•œåƒï¼ˆå†…ç½®ä»£ç ç‰ˆæœ¬ï¼‰
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./build/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            kidself/dockpilot:latest
            kidself/dockpilot:hot
            kidself/dockpilot:${{ steps.version.outputs.VERSION }}
            kidself/dockpilot:${{ steps.version.outputs.VERSION }}-hot
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ“Š é•œåƒæ„å»ºæ€»ç»“
        run: |
          echo "ğŸ³ DockPiloté•œåƒæ„å»ºå®Œæˆï¼"
          echo "ğŸ“‹ é•œåƒä¿¡æ¯:"
          echo "  ä»“åº“: kidself/dockpilot"
          echo "  æ ‡ç­¾: latest, hot, ${{ steps.version.outputs.VERSION }}, ${{ steps.version.outputs.VERSION }}-hot"
          echo "  å¹³å°: linux/amd64, linux/arm64"
          echo "  ç‰¹æ€§: å†…ç½®ä»£ç  + çƒ­æ›´æ–°èƒ½åŠ›"
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
          echo "  # æ¨èæ–¹å¼ï¼ˆlatestå³çƒ­æ›´æ–°ç‰ˆï¼‰"
          echo "  docker run -d --privileged --name dockpilot \\"
          echo "    -p 8888:8888 \\"
          echo "    -v /var/run/docker.sock:/var/run/docker.sock \\"
          echo "    -v /:/mnt/host \\"
          echo "    -v /home/dockpilot:/dockpilot \\"
          echo "    --restart unless-stopped \\"
          echo "    kidself/dockpilot:latest"
          echo ""
          echo "  # æˆ–æ˜ç¡®æŒ‡å®šçƒ­æ›´æ–°ç‰ˆ"
          echo "  docker run -d --privileged --name dockpilot \\"
          echo "    -p 8888:8888 \\"
          echo "    -v /var/run/docker.sock:/var/run/docker.sock \\"
          echo "    -v /:/mnt/host \\"
          echo "    -v /home/dockpilot:/dockpilot \\"
          echo "    --restart unless-stopped \\"
          echo "    kidself/dockpilot:hot"
          echo ""
          echo "ğŸ›¡ï¸ æ–°ç‰¹æ€§:"
          echo "  â€¢ é•œåƒå†…ç½®å½“å‰æœ€æ–°ä»£ç ï¼Œå¯åŠ¨å³å¯ç”¨"
          echo "  â€¢ æ”¯æŒçƒ­æ›´æ–°åˆ°æ›´æ–°ç‰ˆæœ¬"
          echo "  â€¢ ç½‘ç»œæ•…éšœæ—¶è‡ªåŠ¨fallbackåˆ°å†…ç½®ç‰ˆæœ¬"
          echo "  â€¢ åŒé‡ä¿é™©ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§" 