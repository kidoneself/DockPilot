# æ”¯æŒçƒ­æ›´æ–°çš„DockPiloté•œåƒ
# åŸºç¡€ç‰ˆæœ¬ï¼šä¸‹è½½å·²æ„å»ºçš„ä»£ç åŒ… + çƒ­æ›´æ–°èƒ½åŠ›

FROM alpine:3.21

# å£°æ˜æ„å»ºå‚æ•°
ARG VERSION=latest

# å®‰è£…åŸºç¡€å·¥å…·å’Œè¿è¡Œç¯å¢ƒ
RUN apk add --no-cache \
    openjdk11-jre \
    caddy \
    docker-cli \
    wget \
    curl \
    jq \
    tar \
    gzip \
    unzip \
    file \
    util-linux \
    tzdata \
    bash \
    skopeo --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community

# ä¸‹è½½regctl
RUN wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 \
    -O /usr/local/bin/regctl && \
    chmod +x /usr/local/bin/regctl

# å®‰è£… Docker Compose æ’ä»¶
RUN mkdir -p /usr/local/lib/docker/cli-plugins && \
    wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) \
    -O /usr/local/lib/docker/cli-plugins/docker-compose && \
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# è®¾ç½®æ—¶åŒº
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
RUN mkdir -p /app /usr/share/html /dockpilot/data /dockpilot/logs /dockpilot/uploads \
    /app/builtin /usr/share/html-builtin

# ğŸš€ ä¸‹è½½å·²æ„å»ºçš„å‰åç«¯ä»£ç åŒ…
RUN echo "ğŸ“¦ ä¸‹è½½DockPilot ${VERSION} ä»£ç åŒ…..." && \
    if [ "$VERSION" = "latest" ]; then \
        echo "è·å–æœ€æ–°ç‰ˆæœ¬å·..."; \
        LATEST_VERSION=$(wget -qO- https://api.github.com/repos/kidoneself/DockPilot/releases/latest | grep '"tag_name"' | cut -d'"' -f4); \
        if [ -n "$LATEST_VERSION" ]; then \
            VERSION=$LATEST_VERSION; \
            echo "æœ€æ–°ç‰ˆæœ¬: $VERSION"; \
        else \
            echo "âš ï¸ æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ v1.3.0"; \
            VERSION="v1.3.0"; \
        fi; \
    fi && \
    echo "ä¸‹è½½ç‰ˆæœ¬: $VERSION" && \
    wget --tries=3 --retry-connrefused --timeout=60 \
        "https://github.com/kidoneself/DockPilot/releases/download/${VERSION}/frontend.tar.gz" \
        -O /tmp/frontend.tar.gz && \
    wget --tries=3 --retry-connrefused --timeout=60 \
        "https://github.com/kidoneself/DockPilot/releases/download/${VERSION}/backend.jar" \
        -O /tmp/backend.jar && \
    echo "âœ… ä»£ç åŒ…ä¸‹è½½å®Œæˆ"

# ğŸ¯ å®‰è£…å†…ç½®ç‰ˆæœ¬çš„å‰åç«¯ä»£ç 
RUN echo "ğŸ“ å®‰è£…å†…ç½®ä»£ç ..." && \
    tar -xzf /tmp/frontend.tar.gz -C /usr/share/html-builtin/ && \
    cp /tmp/backend.jar /app/builtin/backend.jar && \
    echo "âœ… å†…ç½®ä»£ç å®‰è£…å®Œæˆ"

# å¤åˆ¶å¯åŠ¨è„šæœ¬å’Œé…ç½®
COPY build/start-hot-update.sh /start.sh
COPY build/Caddyfile /etc/caddy/Caddyfile  
COPY build/download-app.sh /app/download-app.sh
COPY build/loading.html /usr/share/html/index.html
COPY build/init-builtin.sh /app/init-builtin.sh

# è®¾ç½®æƒé™
RUN chmod +x /start.sh /app/download-app.sh /app/init-builtin.sh

# ğŸ”¥ åˆå§‹åŒ–ï¼šå¤åˆ¶å†…ç½®ç‰ˆæœ¬åˆ°è¿è¡Œç›®å½•
RUN echo "ğŸ”„ åˆå§‹åŒ–è¿è¡Œç¯å¢ƒ..." && \
    cp -r /usr/share/html-builtin/* /usr/share/html/ && \
    cp /app/builtin/backend.jar /app/app.jar && \
    echo "builtin-${VERSION:-latest}" > /dockpilot/data/current_version && \
    echo "âœ… è¿è¡Œç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
RUN rm -f /tmp/frontend.tar.gz /tmp/backend.jar && \
    echo "ğŸ—‘ï¸ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"

# æš´éœ²ç«¯å£
EXPOSE 8888

# æ•°æ®å·
VOLUME ["/var/run/docker.sock", "/mnt/host", "/dockpilot"]

# å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DOCKPILOT_VERSION=${VERSION:-latest}
ENV DOWNLOAD_URL_BASE=https://github.com/kidoneself/DockPilot/releases/download
ENV BUILTIN_FALLBACK=true

# å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/start.sh"] 