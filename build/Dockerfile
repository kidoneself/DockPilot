# æ”¯æŒçƒ­æ›´æ–°çš„DockPiloté•œåƒ
# åŸºç¡€ç‰ˆæœ¬ï¼šé•œåƒå†…ç½®ä»£ç  + çƒ­æ›´æ–°èƒ½åŠ›

FROM alpine:3.21

# å®‰è£…åŸºç¡€å·¥å…·å’Œè¿è¡Œç¯å¢ƒ
RUN apk add --no-cache \
    openjdk11-jre \
    caddy \
    docker-cli \
    wget \
    curl \
    jq \
    tar \
    gzip \
    unzip \
    file \
    util-linux \
    tzdata \
    bash \
    skopeo --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community

# ä¸‹è½½regctl
RUN wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 \
    -O /usr/local/bin/regctl && \
    chmod +x /usr/local/bin/regctl

# å®‰è£… Docker Compose æ’ä»¶
RUN mkdir -p /usr/local/lib/docker/cli-plugins && \
    wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) \
    -O /usr/local/lib/docker/cli-plugins/docker-compose && \
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# è®¾ç½®æ—¶åŒº
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
RUN mkdir -p /app /usr/share/html /dockpilot/data /dockpilot/logs /dockpilot/uploads \
    /app/builtin /usr/share/html-builtin

# ğŸ”¥ æ–°å¢ï¼šæ„å»ºæ—¶æ‰“åŒ…å‰åç«¯ä»£ç ä½œä¸ºå†…ç½®ç‰ˆæœ¬
# ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œå…ˆæ„å»ºå‰åç«¯ä»£ç 

# Stage 1: æ„å»ºå‰ç«¯
FROM node:18-alpine AS frontend-builder
WORKDIR /build

# å¤åˆ¶å‰ç«¯æºç 
COPY dockpilot-frontend/package*.json ./
RUN npm ci

COPY dockpilot-frontend/ ./
RUN npm run build

# Stage 2: æ„å»ºåç«¯
FROM maven:3.8-openjdk-11-slim AS backend-builder
WORKDIR /build

# å¤åˆ¶åç«¯æºç å’Œpom.xml
COPY dockpilot-backend/pom.xml ./
RUN mvn dependency:go-offline -q

COPY dockpilot-backend/src ./src
RUN mvn clean package -DskipTests -q

# Stage 3: æœ€ç»ˆé•œåƒ
FROM alpine:3.21

# é‡å¤å®‰è£…æ­¥éª¤ï¼ˆå› ä¸ºé‡æ–°å¼€å§‹ï¼‰
RUN apk add --no-cache \
    openjdk11-jre \
    caddy \
    docker-cli \
    wget \
    curl \
    jq \
    tar \
    gzip \
    unzip \
    file \
    util-linux \
    tzdata \
    bash \
    skopeo --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community

# ä¸‹è½½regctl
RUN wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 \
    -O /usr/local/bin/regctl && \
    chmod +x /usr/local/bin/regctl

# å®‰è£… Docker Compose æ’ä»¶
RUN mkdir -p /usr/local/lib/docker/cli-plugins && \
    wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) \
    -O /usr/local/lib/docker/cli-plugins/docker-compose && \
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# è®¾ç½®æ—¶åŒº
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
RUN mkdir -p /app /usr/share/html /dockpilot/data /dockpilot/logs /dockpilot/uploads \
    /app/builtin /usr/share/html-builtin

# ğŸ¯ å¤åˆ¶å†…ç½®ç‰ˆæœ¬çš„å‰åç«¯ä»£ç 
COPY --from=frontend-builder /build/dist/ /usr/share/html-builtin/
COPY --from=backend-builder /build/target/*.jar /app/builtin/backend.jar

# å¤åˆ¶å¯åŠ¨è„šæœ¬å’Œé…ç½®
COPY build/start-hot-update.sh /start.sh
COPY build/Caddyfile /etc/caddy/Caddyfile  
COPY build/download-app.sh /app/download-app.sh
COPY build/loading.html /usr/share/html/index.html
COPY build/init-builtin.sh /app/init-builtin.sh

# è®¾ç½®æƒé™
RUN chmod +x /start.sh /app/download-app.sh /app/init-builtin.sh

# ğŸ”¥ åˆå§‹åŒ–ï¼šå¤åˆ¶å†…ç½®ç‰ˆæœ¬åˆ°è¿è¡Œç›®å½•
RUN cp -r /usr/share/html-builtin/* /usr/share/html/ && \
    cp /app/builtin/backend.jar /app/app.jar && \
    echo "builtin-version" > /dockpilot/data/current_version

# æš´éœ²ç«¯å£
EXPOSE 8888

# æ•°æ®å·
VOLUME ["/var/run/docker.sock", "/mnt/host", "/dockpilot"]

# å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DOCKPILOT_VERSION=${VERSION:-latest}
ENV DOWNLOAD_URL_BASE=https://github.com/kidoneself/DockPilot/releases/download
ENV BUILTIN_FALLBACK=true

# å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/start.sh"] 