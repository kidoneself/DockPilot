# æ”¯æŒçƒ­æ›´æ–°çš„DockPiloté•œåƒ
# åŸºç¡€ç‰ˆæœ¬ï¼šæœ¬åœ°æ„å»ºä»£ç  + çƒ­æ›´æ–°èƒ½åŠ›

FROM alpine:3.21

# å£°æ˜æ„å»ºå‚æ•°
ARG VERSION=v1.0.0

# å®‰è£…åŸºç¡€å·¥å…·å’Œè¿è¡Œç¯å¢ƒ
RUN apk add --no-cache \
    openjdk11-jre \
    caddy \
    docker-cli \
    wget \
    curl \
    jq \
    tar \
    gzip \
    unzip \
    file \
    util-linux \
    tzdata \
    bash \
    shadow \
    su-exec \
    skopeo --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community

# ä¸‹è½½regctl
RUN wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 \
    -O /usr/local/bin/regctl && \
    chmod +x /usr/local/bin/regctl

# å®‰è£… Docker Compose æ’ä»¶
RUN mkdir -p /usr/local/lib/docker/cli-plugins && \
    wget --tries=3 --retry-connrefused --timeout=30 \
    https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) \
    -O /usr/local/lib/docker/cli-plugins/docker-compose && \
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# è®¾ç½®æ—¶åŒº
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
RUN mkdir -p /app /usr/share/html /dockpilot/data /dockpilot/logs /dockpilot/uploads \
    /app/builtin /usr/share/html-builtin

# ğŸ”„ æ”¹ä¸ºå¤åˆ¶æœ¬åœ°æ„å»ºçš„ä»£ç æ–‡ä»¶ï¼ˆè€Œä¸æ˜¯ä¸‹è½½ï¼‰
# è¿™äº›æ–‡ä»¶ç”±GitHub Actionsåœ¨æ„å»ºé•œåƒå‰å‡†å¤‡å¥½
COPY frontend.tar.gz /tmp/frontend.tar.gz
COPY backend.jar /tmp/backend.jar

# ğŸ¯ å®‰è£…å†…ç½®ç‰ˆæœ¬çš„å‰åç«¯ä»£ç 
RUN echo "ğŸ“ å®‰è£…å†…ç½®ä»£ç ..." && \
    tar -xzf /tmp/frontend.tar.gz -C /usr/share/html-builtin/ && \
    cp /tmp/backend.jar /app/builtin/backend.jar && \
    rm -f /tmp/frontend.tar.gz /tmp/backend.jar && \
    echo "âœ… å†…ç½®ä»£ç å®‰è£…å®Œæˆ"

# å¤åˆ¶å¯åŠ¨è„šæœ¬å’Œé…ç½®
COPY build/start-hot-update.sh /start.sh
COPY build/Caddyfile /etc/caddy/Caddyfile  
COPY build/download-app.sh /app/download-app.sh
COPY build/loading.html /usr/share/html/index.html
COPY build/init-builtin.sh /app/init-builtin.sh

# è®¾ç½®æƒé™
RUN chmod +x /start.sh /app/download-app.sh /app/init-builtin.sh

# ğŸ”¥ åˆå§‹åŒ–ï¼šå¤åˆ¶å†…ç½®ç‰ˆæœ¬åˆ°è¿è¡Œç›®å½•
RUN mkdir -p /dockpilot/data && \
    cp -r /usr/share/html-builtin/* /usr/share/html/ && \
    cp /app/builtin/backend.jar /app/app.jar && \
    echo "$VERSION" > /dockpilot/data/current_version && \
    echo "âœ… ç‰ˆæœ¬å·²è®¾ç½®ä¸º: $VERSION"

# ğŸ”¥ è®¾ç½®ç›®å½•æƒé™ï¼ˆå…è®¸PUIDç”¨æˆ·è®¿é—®ï¼‰
RUN chown -R dockpilot:dockpilot /app /usr/share/html /dockpilot && \
    chmod -R 755 /app /usr/share/html && \
    chmod -R 777 /dockpilot

# æš´éœ²ç«¯å£
EXPOSE 8888

# æ•°æ®å·
VOLUME ["/var/run/docker.sock", "/mnt/host", "/dockpilot"]

# å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ”¥ è®¾ç½®PUID/PGID/UMASKç¯å¢ƒå˜é‡
ENV PUID=0
ENV PGID=0
ENV UMASK=022
ENV DOCKPILOT_VERSION=${VERSION}
ENV DOWNLOAD_URL_BASE=https://github.com/kidoneself/DockPilot/releases/download
ENV BUILTIN_FALLBACK=true

# å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/start.sh"] 