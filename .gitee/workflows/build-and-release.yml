name: Build All and Push to Tencent Cloud
on:
  push:
    tags: ['v*']

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          
      # æ„å»ºå‰ç«¯åŒ…
      - name: Build Frontend
        run: |
          cd dockpilotfront
          npm install
          npm run build
          tar -czf ../frontend.tar.gz dist/
          
      # æ„å»ºåç«¯åŒ…
      - name: Build Backend
        run: |
          cd docker-manager-back
          mvn clean package -DskipTests
          cp target/docker-manager-*.jar ../backend.jar
          
      # ç™»å½•è…¾è®¯äº‘TCR
      - name: Login to Tencent Cloud TCR
        run: |
          echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com -u ${{ secrets.TCR_USERNAME }} --password-stdin
          
      # æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: Build and Push Docker Images
        run: |
          # æ„å»ºæ ‡å‡†é•œåƒ
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot:${VERSION} .
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot:latest .
          
          # æ„å»ºçƒ­æ›´æ–°é•œåƒ
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:${VERSION} -f build/Dockerfile .
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:latest -f build/Dockerfile .
          
          # æ¨é€é•œåƒ
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot:${VERSION}
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot:latest
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:${VERSION}
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:latest
          
      # åˆ›å»ºGitee Release
      - name: Create Gitee Release
        uses: gitee/create-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: |
            ## ğŸš€ DockPilot ${{ env.VERSION }}
            
            ### ğŸ“¦ å®‰è£…æ–¹å¼
            
            #### 1. Dockeréƒ¨ç½²ï¼ˆæ¨èï¼Œå›½å†…ç”¨æˆ·ï¼‰
            ```bash
            # è…¾è®¯äº‘é•œåƒï¼ˆå›½å†…ç”¨æˆ·æ¨èï¼‰
            docker pull ccr.ccs.tencentyun.com/kidoneself/dockpilot:latest
            
            # çƒ­æ›´æ–°ç‰ˆæœ¬
            docker pull ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:latest
            ```
            
            #### 2. çƒ­æ›´æ–°éƒ¨ç½²
            ä¸‹è½½ä¸‹æ–¹çš„ä»£ç åŒ…ï¼Œé€šè¿‡DockPilotç®¡ç†ç•Œé¢è¿›è¡Œçƒ­æ›´æ–°ã€‚
            
            #### 3. æ‰‹åŠ¨éƒ¨ç½²
            ä¸‹è½½å‰åç«¯ä»£ç åŒ…è¿›è¡Œæ‰‹åŠ¨éƒ¨ç½²ã€‚
            
          files: |
            frontend.tar.gz
            backend.jar 