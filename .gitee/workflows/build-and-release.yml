name: Build All and Push to Tencent Cloud
on:
  push:
    tags: ['v*']

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          
      # æ„å»ºå‰ç«¯åŒ…
      - name: Build Frontend
        run: |
          cd dockpilot-frontend
          echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
          npm install
          
          # å‡çº§å…³é”®ä¾èµ–ä»¥è§£å†³å…¼å®¹æ€§é—®é¢˜
          npm install vue-tsc@latest --save-dev
          npm install terser --save-dev
          
          echo "ğŸ”§ æ„å»ºå‰ç«¯ï¼ˆè·³è¿‡ç±»å‹æ£€æŸ¥ï¼‰..."
          
          # å¤‡ä»½åŸå§‹ package.json
          cp package.json package.json.backup
          
          # ä¿®æ”¹æ„å»ºè„šæœ¬è·³è¿‡ç±»å‹æ£€æŸ¥
          sed -i.bak 's/"build": "vue-tsc && vite build"/"build": "vite build"/' package.json
          
          # æ‰§è¡Œæ„å»º
          npm run build
          
          # æ¢å¤åŸå§‹ package.json
          mv package.json.backup package.json
          
          echo "ğŸ“ æ‰“åŒ…å‰ç«¯æ–‡ä»¶..."
          tar -czf ../frontend.tar.gz -C dist .
          
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ: frontend.tar.gz"
          
      # æ„å»ºåç«¯åŒ…
      - name: Build Backend
        run: |
          cd dockpilot-backend
          mvn clean package -DskipTests
          
          # æŸ¥æ‰¾æ„å»ºçš„jaræ–‡ä»¶ï¼ˆä¸GitHub Actionsä¿æŒä¸€è‡´ï¼‰
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°jaræ–‡ä»¶"
            exit 1
          fi
          
          echo "æ‰¾åˆ°jaræ–‡ä»¶: $JAR_FILE"
          
          # é‡å‘½åä¸ºç»Ÿä¸€çš„åç§°
          cp "$JAR_FILE" ../backend.jar
          
          echo "âœ… åç«¯æ–‡ä»¶å‡†å¤‡å®Œæˆ: backend.jar"
          
      # ç™»å½•è…¾è®¯äº‘TCR
      - name: Login to Tencent Cloud TCR
        run: |
          echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com -u ${{ secrets.TCR_USERNAME }} --password-stdin
          
      # æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      - name: Build and Push Docker Images
        run: |
          # æ„å»ºæ ‡å‡†é•œåƒ
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot:${VERSION} .
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot:latest .
          
          # æ„å»ºçƒ­æ›´æ–°é•œåƒ
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:${VERSION} -f build/Dockerfile .
          docker build -t ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:latest -f build/Dockerfile .
          
          # æ¨é€é•œåƒ
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot:${VERSION}
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot:latest
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:${VERSION}
          docker push ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:latest
          
      # åˆ›å»ºGitee Release
      - name: Create Gitee Release
        uses: gitee/create-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: |
            ## ğŸš€ DockPilot ${{ env.VERSION }}
            
            ### ğŸ“¦ å®‰è£…æ–¹å¼
            
            #### 1. Dockeréƒ¨ç½²ï¼ˆæ¨èï¼Œå›½å†…ç”¨æˆ·ï¼‰
            ```bash
            # è…¾è®¯äº‘é•œåƒï¼ˆå›½å†…ç”¨æˆ·æ¨èï¼‰
            docker pull ccr.ccs.tencentyun.com/kidoneself/dockpilot:latest
            
            # çƒ­æ›´æ–°ç‰ˆæœ¬
            docker pull ccr.ccs.tencentyun.com/kidoneself/dockpilot-hot:latest
            ```
            
            #### 2. çƒ­æ›´æ–°éƒ¨ç½²
            ä¸‹è½½ä¸‹æ–¹çš„ä»£ç åŒ…ï¼Œé€šè¿‡DockPilotç®¡ç†ç•Œé¢è¿›è¡Œçƒ­æ›´æ–°ã€‚
            
            #### 3. æ‰‹åŠ¨éƒ¨ç½²
            ä¸‹è½½å‰åç«¯ä»£ç åŒ…è¿›è¡Œæ‰‹åŠ¨éƒ¨ç½²ã€‚
            
          files: |
            frontend.tar.gz
            backend.jar 