# Docker Manager 改造方案

## 需求总结

1. **操作状态管理**
   - 使用内存Map存储容器操作状态
   - 状态流转：pending → running → success/failed
   - 无需数据库持久化

2. **容器状态同步**
   - 定时任务每5秒同步Docker状态
   - 状态变化时通过WebSocket推送
   - 无需数据库持久化

3. **WebSocket通信**
   - 前端建立全局WebSocket连接
   - 统一的消息格式
   - 实时推送状态变化

4. **操作冲突控制**
   - 使用本地内存锁
   - 防止同一容器并发操作
   - 无需分布式锁

## 全局状态管理设计

### ContainerContext设计
```java
@Component
public class ContainerContext {
    // 容器操作状态缓存
    private final ConcurrentHashMap<String, String> containerOperationStatus = new ConcurrentHashMap<>();
    
    // 容器状态缓存
    private final ConcurrentHashMap<String, ContainerStatus> containerStatus = new ConcurrentHashMap<>();
    
    // 容器操作锁
    private final ConcurrentHashMap<String, Lock> containerLocks = new ConcurrentHashMap<>();
    
    // 其他方法...
}
```

## 任务清单

### 后端改造
[ ] 1. 实现全局状态管理
   - [ ] 创建ContainerContext类
   - [ ] 实现容器操作状态管理
   - [ ] 实现容器状态缓存
   - [ ] 实现操作锁管理
   - [ ] 添加状态查询方法
   - [ ] 添加状态更新方法
   - [ ] 添加锁管理方法

[ ] 2. 实现容器状态同步
   - [ ] 创建定时同步任务
   - [ ] 实现Docker状态获取
   - [ ] 实现状态对比逻辑
   - [ ] 集成ContainerContext

[ ] 3. 实现WebSocket服务
   - [ ] 创建WebSocket配置
   - [ ] 实现消息推送逻辑
   - [ ] 实现消息格式封装
   - [ ] 集成ContainerContext

[ ] 4. 实现操作冲突控制
   - [ ] 使用ContainerContext的锁管理
   - [ ] 实现锁获取和释放
   - [ ] 添加超时处理
   - [ ] 添加异常处理

### 前端改造
[ ] 1. 实现全局WebSocket连接
   - [ ] 创建WebSocket管理类
   - [ ] 实现连接管理
   - [ ] 实现重连机制

[ ] 2. 实现消息处理
   - [ ] 创建消息分发器
   - [ ] 实现不同类型消息处理
   - [ ] 实现状态更新逻辑

[ ] 3. 实现UI更新
   - [ ] 更新容器列表组件
   - [ ] 更新操作按钮状态
   - [ ] 实现状态提示

### 测试
[ ] 1. 单元测试
   - [ ] 测试ContainerContext
   - [ ] 测试操作状态管理
   - [ ] 测试状态同步
   - [ ] 测试WebSocket通信

[ ] 2. 集成测试
   - [ ] 测试完整操作流程
   - [ ] 测试并发操作
   - [ ] 测试异常情况

### 文档
[ ] 1. 更新API文档
[ ] 2. 更新部署文档
[ ] 3. 更新使用说明

## 完成标准
1. 所有任务清单项标记为完成
2. 通过所有测试
3. 文档更新完成
4. 代码审查通过 