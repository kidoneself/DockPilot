# DockPilot çƒ­æ›´æ–°ç‰ˆæœ¬ Caddy é…ç½®
# åŠŸèƒ½å®Œæ•´ç‰ˆæœ¬ï¼Œæ”¯æŒå¥åº·æ£€æŸ¥ã€CORSã€é”™è¯¯å¤„ç†ç­‰

# DockPilot Caddy é…ç½® - æ”¯æŒçƒ­æ›´æ–°å’Œé›¶åœæœºéƒ¨ç½²
{
    # å¯ç”¨Admin API (ç›‘å¬æ‰€æœ‰æ¥å£)
    admin :2019
    
    # è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œå‡å°‘å¥åº·æ£€æŸ¥å¤±è´¥æ—¥å¿—
    log {
        level INFO
    }
    
    # å…¨å±€é€‰é¡¹
    auto_https off
    local_certs
}

# ä¸»æœåŠ¡é…ç½®
:8888 {
    # å¯ç”¨è®¿é—®æ—¥å¿—
    log {
        output file /dockpilot/logs/caddy-access.log
        format json
    }
    
    # é”™è¯¯å¤„ç† - å½“åç«¯ä¸å¯ç”¨æ—¶æ˜¾ç¤ºæ›´æ–°é¡µé¢
    handle_errors {
        @update_error expression {http.error.status_code} == 502
        handle @update_error {
            respond `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DockPilot æ­£åœ¨æ›´æ–°</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            color: white;
        }
        .container { 
            text-align: center; padding: 2rem;
            background: rgba(255,255,255,0.1); border-radius: 15px;
            backdrop-filter: blur(10px); max-width: 500px;
        }
        .logo { font-size: 3rem; margin-bottom: 1rem; }
        .spinner { 
            width: 50px; height: 50px; margin: 2rem auto;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message { font-size: 1.2rem; margin: 1rem 0; }
        .details { font-size: 0.9rem; opacity: 0.8; margin-top: 1rem; }
        .refresh-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 0.5rem 1rem; border-radius: 5px;
            cursor: pointer; margin-top: 1rem; font-size: 0.9rem;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.3); }
    </style>
    <script>
        let checkCount = 0;
        const maxChecks = 120;
        
        function checkBackend() {
            if (checkCount >= maxChecks) {
                document.getElementById('message').innerHTML = 'âš ï¸ æ›´æ–°æ—¶é—´è¾ƒé•¿ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢';
                return;
            }
            
            checkCount++;
            fetch('/api/update/version')
                .then(response => {
                    if (response.ok) {
                        document.getElementById('message').innerHTML = 'âœ… æ›´æ–°å®Œæˆï¼Œæ­£åœ¨è·³è½¬...';
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        setTimeout(checkBackend, 2000);
                    }
                })
                .catch(() => {
                    setTimeout(checkBackend, 2000);
                });
        }
        
        window.onload = () => setTimeout(checkBackend, 3000);
    </script>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸš€</div>
        <h1>DockPilot æ­£åœ¨æ›´æ–°</h1>
        <div class="spinner"></div>
        <div class="message" id="message">
            ç³»ç»Ÿæ­£åœ¨è¿›è¡Œçƒ­æ›´æ–°ï¼Œé¢„è®¡éœ€è¦1-2åˆ†é’Ÿ<br>
            è¯·ç¨ç­‰ï¼Œæ›´æ–°å®Œæˆåå°†è‡ªåŠ¨åˆ·æ–°é¡µé¢
        </div>
        <div class="details">
            ğŸ”„ å‰åç«¯ä»£ç æ­£åœ¨æ›´æ–°<br>
            ğŸ“¦ æ— éœ€é‡å¯å®¹å™¨ï¼Œä¿æŒæ•°æ®å®Œæ•´
        </div>
        <button class="refresh-btn" onclick="location.reload()">æ‰‹åŠ¨åˆ·æ–°</button>
    </div>
</body>
</html>` 502
        }
        
        respond "DockPilot æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•" {http.error.status_code}
    }
    
    # CORS å¤„ç†
    @options method OPTIONS
    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }
    
    # APIä»£ç†é…ç½® - ç®€åŒ–ç‰ˆæœ¬ï¼Œé¿å…å¥åº·æ£€æŸ¥æ—¥å¿—å¹²æ‰°
    handle /api/* {
        # é‡å†™è·¯å¾„ï¼šå»æ‰ /api å‰ç¼€
        uri strip_prefix /api
        
        reverse_proxy localhost:8080 {
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
        }
        
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
    }
    
    # WebSocketä»£ç†
    handle /ws/* {
        reverse_proxy localhost:8080 {
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Host {upstream_hostport}
            header_up X-Real-IP {remote_host}
        }
    }
    
    # ä¸Šä¼ æ–‡ä»¶é™æ€æœåŠ¡
    handle /uploads/* {
        root * /dockpilot
        
        # ç¼“å­˜é…ç½®
        header Cache-Control "public, max-age=31536000"
        header X-Content-Type-Options nosniff
        
        # ç›´æ¥æä¾›æ–‡ä»¶æœåŠ¡
        file_server
    }
    
    # é™æ€æ–‡ä»¶æœåŠ¡
    handle {
        root * /usr/share/html
        
        # ç¼“å­˜é…ç½®
        @static path_regexp \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$
        header @static Cache-Control "public, max-age=31536000"
        
        @html path_regexp \.(html|htm)$
        header @html Cache-Control "no-cache, no-store, must-revalidate"
        
        # SPAè·¯ç”±æ”¯æŒ
        try_files {path} /index.html
        file_server
    }
    
    # å®‰å…¨å¤´
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
} 