# DockPilot 热更新版本 Caddy 配置
# 基于原版配置，增加热更新支持

:8888 {
    root * /usr/share/html

    # API 代理到后端（增加超时支持长时间更新操作）
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy localhost:8080 {
            transport http {
                dial_timeout 30s
                read_timeout 300s
                write_timeout 300s
            }
        }
    }

    # WebSocket 代理
    handle /ws/* {
        reverse_proxy localhost:8080
    }

    # 文件上传服务
    handle /uploads/* {
        root * /dockpilot
        file_server
        header Cache-Control "public, max-age=2592000"
        header Access-Control-Allow-Origin "*"
    }

    # 前端路由处理（SPA 支持）
    handle {
        # HTML 文件不缓存，支持热更新
        @html path_regexp \.(html|htm)$
        header @html Cache-Control "no-cache, no-store, must-revalidate"
        header @html Pragma "no-cache"
        header @html Expires "0"
        
        # 静态资源适当缓存
        @static path_regexp \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$
        header @static Cache-Control "public, max-age=3600"
        
        try_files {path} /index.html
        file_server
    }

    # 访问日志
    log {
        output file /dockpilot/logs/caddy.log
        level INFO
    }

    # 基础压缩
    encode gzip

    # 基础安全头
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
} 